<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Liner Design Calculator</title>
  <link rel="manifest" href="manifest.json">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #1e293b;
      color: #f1f5f9;
      margin: 0;
      padding: 2rem;
    }
    h1 {
      font-size: 2rem;
      margin-bottom: 1.5rem;
      text-align: center;
    }
    label {
      margin-top: 1rem;
      display: block;
    }
    input, select, button {
      width: 100%;
      max-width: 300px;
      padding: 0.5rem;
      margin-top: 0.25rem;
      margin-bottom: 0.75rem;
      border-radius: 0.375rem;
      border: 1px solid #94a3b8;
      background-color: #334155;
      color: #f1f5f9;
      display: block;
      box-sizing: border-box;
    }
    button {
      background-color: #3b82f6;
      border: none;
      cursor: pointer;
    }
    .result {
      background-color: #0f172a;
      border-radius: 0.5rem;
      padding: 1rem;
      margin-top: 1.5rem;
      color: #e2e8f0;
      width: 100%;
      max-width: 300px;
      box-sizing: border-box;
      margin-left: auto;
      margin-right: auto;
    }
    .result strong {
      display: block;
      font-size: 1.25rem;
      margin-bottom: 0.75rem;
    }
  </style>
</head>
<body>
  <div style="max-width: 500px; margin: auto;">
    <h1>Liner Design Calculator</h1>
    <label for="diameter">Installed Diameter (inches)</label>
    <input type="number" id="diameter" step="0.1" />
    <label for="totalGauge">Total Liner Gauge (mm)</label>
    <input type="number" id="totalGauge" step="0.1" />
    <label for="coating">Liner Type</label>
    <select id="coating">
      <option value="TPU">PU</option>
      <option value="Potable">Potable</option>
      <option value="TPO">TPO / Envirocure</option>
      <option value="UV">UV</option>
      <option value="TPO2.0">TPO (2.0 mm)</option>
    </select>
    <label for="join">Felt Join Type</label>
    <select id="join">
      <option value="sew">Sew</option>
      <option value="weld">Weld</option>
      <option value="glass">Welded Glass</option>
    </select>
    <button onclick="runCalc()">Calculate</button>
    <button id="installBtn" style="display:none; background-color:#10b981; margin-top:0.5rem;">Install App</button>
    <div class="result" id="output"></div>
  </div>

  <script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('service-worker.js');
  });
}
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault(); deferredPrompt = e;
  window.addEventListener('load', () => {
    const btn = document.getElementById('installBtn');
    if (btn) btn.style.display = 'block';
  });
});
window.addEventListener('DOMContentLoaded', () => {
  ['diameter','totalGauge','coating','join'].forEach(id => {
    const el = document.getElementById(id);
    el && el.addEventListener(id==='diameter'||id==='totalGauge'?'input':'change', runCalc);
  });
});
function getFeltShrinkFactor(d, i) {
  switch(i) {
    case 0: return -0.000981*d + 0.951465;
    case 1: return  0.000928*d + 0.947715;
    case 2: return  0.008332*d + 0.499900;
    case 3: return  0.008334*d + 0.500050;
    default: return 1.0;
  }
}
function determineFeltLayers(feltOnlyGauge) {
  const available=[2.0,3.0,4.0,4.5,6.0]; let best=[],minL=Infinity,closest=Infinity;
  function find(c,s,i) {
    if(s>feltOnlyGauge+0.01||c.length>5) return;
    const diff=Math.abs(s-feltOnlyGauge);
    if(diff<closest||(diff===closest&&c.length<minL)){
      closest=diff;minL=c.length;best=[...c];
    }
    for(let j=i;j<available.length;j++) find([...c,available[j]],s+available[j],j);
  }
  find([],0,0);
  return best.sort((a,b)=>a-b);
}
function calculateLayflats(D_final,totalGauge,coatingType,joinType){
  const mmIn=25.4;
  const coatingGauge = (coatingType==='TPO2.0'?2.0:3.0);
  const shrinkCoat = coatingType==='TPU'?0.92:
                     coatingType==='Potable'?0.96:
                     coatingType==='TPO2.0'?0.92:
                     coatingType==='UV'?0.94:
                     0.94;
  const feltGauge=totalGauge-coatingGauge;
  const feltGauges=determineFeltLayers(feltGauge);
  let sum=0;
  const feltResults=[];
  feltGauges.forEach((g,i)=>{
    const D_eff=D_final-2*(sum/mmIn);
    const circ=Math.PI*D_eff*mmIn;
    const F=getFeltShrinkFactor(D_final,i);
    const overlap=joinType==='weld'?(D_final<=15?25:50):(joinType==='glass'?50:0);
    const W=circ*F;
    feltResults.push({label:`${i+1}${['st','nd','rd'][i]||'th'} Inner`,gauge:g,width:Math.round(W+overlap)});
    sum+=g;
  });
  const Dmm=D_final*mmIn;
  const coatedWidth=Math.round((Dmm-2*totalGauge)*shrinkCoat*Math.PI);
  return {feltResults,coatedWidth,totalGauge,shrinkCoat};
}
function runCalc(){
  const D=parseFloat(document.getElementById('diameter').value);
  const TG=parseFloat(document.getElementById('totalGauge').value);
  const CT=document.getElementById('coating').value;
  const JT=document.getElementById('join').value;
  if(isNaN(D)||isNaN(TG)){document.getElementById('output').innerHTML='';return;}
  const res=calculateLayflats(D,TG,CT,JT);
  let html=`<strong>Results</strong><br>Total Layers: ${res.feltResults.length+1}<br>`+
           `Total Gauge: ${res.totalGauge} mm<br>`+
           `Downsizing (Coated Layer): ${ (res.shrinkCoat*100).toFixed(0) }%<br>`+
           `Coated Width: ${res.coatedWidth} mm<br>`;
  res.feltResults.forEach(l=>html+=`${l.label}: ${l.width} mm (${l.gauge} mm)<br>`);
  document.getElementById('output').innerHTML=html;
}
  </script>
</body>
</html>
